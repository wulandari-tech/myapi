
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WANZOFC TECH - Harga Paket API</title>
    <link rel="stylesheet" href="css/global-animations.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif; margin: 0; background-color: #0f0f1f; color: #e0e0e0; line-height: 1.6;
            overflow-x: hidden;
        }
        .navbar {
            background-color: #1a1a2f; padding: 1rem 2rem; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar .logo { font-size: 1.6rem; font-weight: 700; color: #58a6ff; text-decoration: none; }
        .navbar .nav-links a {
            color: #c0c0c0; text-decoration: none; margin-left: 1.5rem; font-size: 1rem; transition: color 0.3s ease;
        }
        .navbar .nav-links a:hover, .navbar .nav-links a.active { color: #58a6ff; }
        .pricing-header {
            text-align: center; padding: 80px 20px 60px; background: linear-gradient(135deg, #1a1a2f 0%, #2c3e50 100%); color: #ffffff;
        }
        .pricing-header h1 { font-size: 2.8rem; margin-bottom: 0.5rem; font-weight:700; }
        .pricing-header p { font-size: 1.1rem; max-width: 600px; margin: 0 auto; opacity: 0.9; }
        .pricing-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            padding: 50px 20px; gap: 30px; max-width: 1200px; margin: 0 auto;
        }
        .pricing-card {
            background-color: #1a1a2f; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            padding: 30px; text-align: center; display: flex;
            flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #2a2a4a;
        }
        .pricing-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 10px 30px rgba(0, 123, 255, 0.2); }
        .pricing-card.popular { border: 3px solid #58a6ff; position: relative; }
        .pricing-card.popular::before {
            content: "Populer"; position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            background-color: #58a6ff; color: #1a1a2f; padding: 5px 15px; border-radius: 20px;
            font-size: 0.9rem; font-weight: bold;
        }
        .pricing-card h3 { font-size: 1.8rem; color: #ffffff; margin-bottom: 10px; }
        .pricing-card .price { font-size: 2.5rem; font-weight: 700; color: #58a6ff; margin-bottom: 10px; }
        .pricing-card .price span { font-size: 1rem; font-weight: normal; color: #b0b0b0; }
        .pricing-card ul { list-style: none; padding: 0; margin: 20px 0; text-align: left; flex-grow: 1; }
        .pricing-card ul li { margin-bottom: 10px; font-size: 1rem; color: #c0c0c0; display: flex; align-items: center; }
        .pricing-card ul li::before { content: '✓'; color: #2ecc71; font-weight: bold; margin-right: 10px; font-size: 1.2rem; }
        .pricing-card .cta-button {
            background-color: #58a6ff; color: #1a1a2f; padding: 12px 25px; text-decoration: none;
            border-radius: 5px; font-weight: bold; transition: background-color 0.3s ease, transform 0.2s ease;
            display: block; margin-top: auto; cursor: pointer; border: none; font-size: 1rem;
        }
        .pricing-card.popular .cta-button { background-color: #388bfd; }
        .pricing-card .cta-button:hover { background-color: #388bfd; transform: translateY(-2px); }
        .pricing-card.popular .cta-button:hover { background-color: #1f638f; }
        .pricing-card .cta-button:disabled { background-color: #555; cursor:not-allowed; transform:none; }
        .footer { background-color: #050515; color: #a0a0a0; text-align: center; padding: 30px 20px; }
        .message { margin: 20px auto; padding: 10px; border-radius: 5px; font-size: 0.9rem; text-align: center; max-width: 600px; color: white;}
        .message.error { background-color: #ff4d4d; }
        .message.success { background-color: #4CAF50; }
        .message.info { background-color: #17a2b8; }

        .payment-modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
            align-items: center; justify-content: center;
        }
        .payment-modal-content {
            background-color: #1a1a2f; margin: auto; padding: 25px; border-radius: 8px;
            width: 90%; max-width: 500px; text-align: center; color: #e0e0e0;
            border: 1px solid #2a2a4a; box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        }
        .payment-modal-content h3 { margin-top:0; color:#ffffff; }
        .payment-modal-content .close-modal {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .payment-modal-content .close-modal:hover, .close-modal:focus { color: #58a6ff; }
        .payment-options button {
            background-color: #58a6ff; color:#1a1a2f; border:none; padding: 10px 15px; margin: 10px 5px;
            border-radius: 5px; cursor:pointer; font-size: 1em; min-width: 150px; font-weight:600;
            transition: background-color 0.3s, transform 0.2s;
        }
        .payment-options button:hover { background-color: #388bfd; transform: translateY(-2px); }
        .payment-options button.qris-btn { background-color: #2ecc71; }
        .payment-options button.qris-btn:hover { background-color: #25a25a; }
        
        #qrisDisplayArea { margin-top: 15px; }
        #qrisDisplayArea img { max-width: 250px; margin-top: 10px; border: 1px solid #3a3a5a; padding:5px; border-radius: 4px; background-color: white;}
        #qrisDisplayArea p {font-size: 0.9em; color: #c0c0c0; margin-bottom: 5px;}
        #paymentStatusArea { margin-top:15px; font-weight: bold;}

        @media (max-width: 768px) {
            .pricing-header h1 { font-size: 2.2rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar animate-on-scroll" data-gsap-delay="0.1">
        <a href="index.html" class="logo">WANZOFC TECH</a>
        <div class="nav-links">
            <a href="/#features">Fitur</a>
            <a href="/pricing" class="active">Harga</a>
            <a href="/dashboard" id="navDashboardLink">Dashboard</a>
            <a href="/login" id="navLoginLink">Login</a>
            <a href="/register" id="navRegisterLink">Register</a>
            <a href="#" id="navLogoutLink" style="display:none;">Logout</a>
        </div>
    </nav>

    <header class="pricing-header animate-on-scroll" data-gsap-y-from="30" data-gsap-delay="0.2">
        <h1>Paket API Key Fleksibel</h1>
        <p>Pilih paket yang paling sesuai dengan kebutuhan proyek Anda. Mulai gratis dan upgrade kapan saja.</p>
    </header>
    <div id="message-area-pricing" class="message" style="display: none;"></div>

    <div class="pricing-container stagger-children-on-scroll" data-gsap-stagger="0.15" data-gsap-delay="0.3" data-gsap-y-from="25">
        <div class="pricing-card">
            <h3>Gratis</h3>
            <div class="price">Rp0<span>/bulan</span></div>
            <ul>
                <li>100 Request/Hari</li>
                <li>Akses Fitur Dasar</li>
                <li>Dukungan Komunitas</li>
                <li>Watermark (pada beberapa API)</li>
            </ul>
            <button class="cta-button" data-plan="Free">Mulai Gratis</button>
        </div>

        <div class="pricing-card popular">
            <h3>Developer</h3>
            <div class="price">Rp5.000<span>/bulan</span></div>
            <ul>
                <li>5.000 Request/Hari</li>
                <li>Akses Semua Fitur</li>
                <li>Tanpa Watermark</li>
                <li>Dukungan Prioritas</li>
                <li>Custom API Key (Aktif 2 Bulan)</li>
            </ul>
            <button class="cta-button" data-plan="Developer">Pilih Developer</button>
        </div>

        <div class="pricing-card">
            <h3>Bisnis</h3>
            <div class="price">Rp10.000<span>/bulan</span></div>
            <ul>
                <li>50.000 Request/Hari</li>
                <li>Akses Semua Fitur & SLA</li>
                <li>Manajer Akun Khusus</li>
                <li>Analitik Penggunaan API</li>
                <li>Custom API Key (Aktif 2 Bulan)</li>
            </ul>
            <button class="cta-button" data-plan="Business">Pilih Bisnis</button>
        </div>
    </div>

    <div id="paymentModal" class="payment-modal">
        <div class="payment-modal-content animate-on-scroll" data-gsap-scale-from="0.8" data-gsap-duration="0.5">
            <span class="close-modal" id="closePaymentModal">&times;</span>
            <h3 id="paymentModalTitle">Konfirmasi Pembayaran</h3>
            <p id="paymentModalSubtitle"></p>
            <div id="paymentOptions" class="payment-options">
                <button id="payWithMidtransBtn">Bayar dengan Midtrans</button>
                <button id="payWithQrisBtn" class="qris-btn">Bayar dengan QRIS</button>
            </div>
            <div id="qrisDisplayArea" style="display:none;">
                <img id="qrisImage" src="" alt="QRIS Code">
                <p id="qrisAmount">Total Bayar: Rp <span id="qrisAmountValue">0</span></p>
                <p id="qrisExpiry">Berlaku sampai: <span id="qrisExpiryValue"></span></p>
                <p>Order ID: <strong id="qrisOrderId"></strong></p>
                <button id="checkOrkutPaymentBtn" style="margin-top:10px;">Saya Sudah Bayar (Cek Status)</button>
            </div>
            <div id="paymentStatusArea"></div>
        </div>
    </div>

    <footer class="footer animate-on-scroll" data-gsap-y-from="20" data-gsap-delay="0.4">
        <p>© <span id="year"></span> WANZOFC TECH. All Rights Reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="js/global-animations.js"></script>
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        const token = localStorage.getItem('wanzofcToken');
        let loggedInUser = localStorage.getItem('wanzofcUser') ? JSON.parse(localStorage.getItem('wanzofcUser')) : null;
        const messageAreaPricing = document.getElementById('message-area-pricing');
        
        const navLoginLink = document.getElementById('navLoginLink');
        const navRegisterLink = document.getElementById('navRegisterLink');
        const navDashboardLink = document.getElementById('navDashboardLink');
        const navLogoutLink = document.getElementById('navLogoutLink');

        if (token && loggedInUser) {
            navLoginLink.style.display = 'none';
            navRegisterLink.style.display = 'none';
            navDashboardLink.style.display = 'inline-block';
            navLogoutLink.style.display = 'inline-block';
            navLogoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('wanzofcToken');
                localStorage.removeItem('wanzofcUser');
                loggedInUser = null;
                window.location.href = '/';
            });
        } else {
            navDashboardLink.style.display = 'none';
        }

        const paymentModal = document.getElementById('paymentModal');
        const paymentModalContent = paymentModal.querySelector('.payment-modal-content');
        const closePaymentModalBtn = document.getElementById('closePaymentModal');
        const paymentModalTitle = document.getElementById('paymentModalTitle');
        const paymentModalSubtitle = document.getElementById('paymentModalSubtitle');
        const paymentOptionsDiv = document.getElementById('paymentOptions');
        const payWithMidtransBtn = document.getElementById('payWithMidtransBtn');
        const payWithQrisBtn = document.getElementById('payWithQrisBtn');

        const qrisDisplayArea = document.getElementById('qrisDisplayArea');
        const qrisImage = document.getElementById('qrisImage');
        const qrisAmountValue = document.getElementById('qrisAmountValue');
        const qrisExpiryValue = document.getElementById('qrisExpiryValue');
        const qrisOrderIdSpan = document.getElementById('qrisOrderId');
        const checkOrkutPaymentBtn = document.getElementById('checkOrkutPaymentBtn');
        const paymentStatusArea = document.getElementById('paymentStatusArea');
        
        let currentPlanToUpgrade = null;
        let currentPlanPrice = 0;
        let currentTransactionOrderId = null;
        let originalCtaButton = null;

        function openPaymentModal() {
            paymentModal.style.display = "flex";
            gsap.fromTo(paymentModalContent, {opacity:0, scale:0.7, y:-20}, {opacity:1, scale:1, y:0, duration:0.4, ease:"back.out(1.7)"});
        }
        function closePaymentModal() {
            gsap.to(paymentModalContent, {opacity:0, scale:0.7, y:-20, duration:0.3, ease:"power2.in", onComplete: () => {
                paymentModal.style.display = "none";
                qrisDisplayArea.style.display = "none";
                paymentOptionsDiv.style.display = "block";
                paymentStatusArea.textContent = "";
                if(originalCtaButton) originalCtaButton.disabled = false;
            }});
        }

        closePaymentModalBtn.onclick = closePaymentModal;
        window.onclick = function(event) {
            if (event.target == paymentModal) {
                closePaymentModal();
            }
        }

        function showMessagePricing(message, type = 'error') {
            messageAreaPricing.textContent = message;
            messageAreaPricing.className = `message ${type}`;
            messageAreaPricing.style.display = 'block';
            gsap.fromTo(messageAreaPricing, {opacity:0, y:-10}, {opacity:1, y:0, duration:0.3});
            setTimeout(() => { 
                gsap.to(messageAreaPricing, {opacity:0, y:-10, duration:0.3, onComplete: () => {
                     messageAreaPricing.style.display = 'none';
                }});
            }, 7000);
        }

        document.querySelectorAll('.pricing-card .cta-button').forEach(button => {
            button.addEventListener('click', async function() {
                originalCtaButton = this;
                const plan = this.dataset.plan;
                currentPlanToUpgrade = plan;
                this.disabled = true;
                
                if (plan === "Free") {
                    if (!token) { window.location.href = 'register.html'; } 
                    else { showMessagePricing('Plan Gratis Anda sudah aktif. Tidak ada tindakan diperlukan.', 'success'); }
                    this.disabled = false;
                    return;
                }
                
                if (!token || !loggedInUser) {
                    showMessagePricing('Anda harus login terlebih dahulu untuk memilih plan berbayar.', 'error');
                    setTimeout(() => window.location.href = `login.html?redirect=pricing.html&plan=${plan}`, 2000);
                    this.disabled = false;
                    return;
                }
                
                if (loggedInUser.plan === plan) {
                    const planExpiration = loggedInUser.planExpirationDate ? new Date(loggedInUser.planExpirationDate) : null;
                    if (planExpiration && planExpiration > new Date()) {
                        showMessagePricing(`Anda sudah berada di plan ${plan} dan masih aktif hingga ${planExpiration.toLocaleDateString('id-ID', {day: 'numeric', month:'long', year:'numeric'})}.`, 'info');
                        this.disabled = false;
                        return;
                    }
                }
                
                currentPlanPrice = plan === 'Developer' ? 5000 : 10000;
                paymentModalTitle.textContent = `Upgrade ke Plan ${plan}`;
                paymentModalSubtitle.textContent = `Biaya: Rp ${currentPlanPrice.toLocaleString('id-ID')},- / 2 Bulan`;
                openPaymentModal();
                paymentStatusArea.textContent = ""; 
                qrisDisplayArea.style.display = "none";
                paymentOptionsDiv.style.display = "block";
            });
        });

        async function initiatePayment(paymentMethod) {
            paymentOptionsDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
            paymentStatusArea.innerHTML = `Memproses... <div class="spinner" style="width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-left-color:#58a6ff; border-radius:50%; display:inline-block; animation: spin 1s linear infinite; vertical-align:middle; margin-left:5px;"></div>`;
            gsap.to(paymentOptionsDiv, {opacity:0, duration:0.3, onComplete: () => paymentOptionsDiv.style.display = "none"});
            qrisDisplayArea.style.display = "none";

            try {
                const response = await fetch('/api/payment/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ plan: currentPlanToUpgrade, paymentMethod: paymentMethod })
                });
                const data = await response.json();

                if (data.success) {
                    currentTransactionOrderId = data.orderId;
                    if (paymentMethod === 'ORKUT_QRIS' && data.qrImageUrl) {
                        qrisImage.src = data.qrImageUrl;
                        qrisAmountValue.textContent = data.amountToPayWithFee.toLocaleString('id-ID');
                        qrisExpiryValue.textContent = new Date(data.expiredAt).toLocaleString('id-ID', { day: 'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'});
                        qrisOrderIdSpan.textContent = data.orderId;
                        qrisDisplayArea.style.display = "block";
                        gsap.fromTo(qrisDisplayArea, {opacity:0, y:20}, {opacity:1, y:0, duration:0.4, delay:0.2});
                        paymentStatusArea.textContent = "Silakan scan QRIS di atas untuk membayar.";
                    } else if (paymentMethod === 'MIDTRANS_SNAP' && data.redirect_url) {
                        paymentStatusArea.textContent = "Mengarahkan ke halaman pembayaran Midtrans...";
                        localStorage.setItem('pendingMidtransOrder', data.orderId);
                        localStorage.setItem('pendingMidtransPlan', currentPlanToUpgrade);
                        window.location.href = data.redirect_url; 
                    } else {
                         paymentStatusArea.textContent = data.message || "Gagal memproses metode pembayaran ini.";
                         gsap.to(paymentOptionsDiv, {opacity:1, duration:0.3, onComplete: () => paymentOptionsDiv.style.display = "block"});
                    }
                } else {
                    paymentStatusArea.textContent = data.message || `Gagal memulai proses pembayaran.`;
                    gsap.to(paymentOptionsDiv, {opacity:1, duration:0.3, onComplete: () => paymentOptionsDiv.style.display = "block"});
                }
            } catch (error) {
                paymentStatusArea.textContent = 'Terjadi kesalahan server saat memulai pembayaran.';
                gsap.to(paymentOptionsDiv, {opacity:1, duration:0.3, onComplete: () => paymentOptionsDiv.style.display = "block"});
            } finally {
                paymentOptionsDiv.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        }
        
        payWithMidtransBtn.addEventListener('click', () => initiatePayment('MIDTRANS_SNAP'));
        payWithQrisBtn.addEventListener('click', () => initiatePayment('ORKUT_QRIS'));

        checkOrkutPaymentBtn.addEventListener('click', async () => {
            if (!currentTransactionOrderId) {
                paymentStatusArea.textContent = "Tidak ada ID transaksi untuk dicek."; return;
            }
            checkOrkutPaymentBtn.disabled = true;
            checkOrkutPaymentBtn.textContent = "Mengecek...";
            paymentStatusArea.textContent = `Mengecek status Order ID: ${currentTransactionOrderId}...`;
            try {
                const statusRes = await fetch(`/api/payment/status/orkut/${currentTransactionOrderId}`, { headers: {'Authorization': `Bearer ${token}`} });
                const statusData = await statusRes.json();
                paymentStatusArea.textContent = statusData.message;
                if (statusData.isPaid) {
                    showMessagePricing('Pembayaran berhasil! Plan Anda telah diupgrade.', 'success');
                    setTimeout(() => window.location.href = 'dashboard.html', 3000);
                }
            } catch (error) {
                paymentStatusArea.textContent = "Gagal menghubungi server untuk cek status.";
            } finally {
                checkOrkutPaymentBtn.disabled = false;
                checkOrkutPaymentBtn.textContent = "Saya Sudah Bayar (Cek Status)";
            }
        });
        
        const urlParamsOnLoad = new URLSearchParams(window.location.search);
        const autoSelectPlan = urlParamsOnLoad.get('autoSelectPlan');
        if (autoSelectPlan && token) {
             const buttonToClick = document.querySelector(`.pricing-card .cta-button[data-plan="${autoSelectPlan}"]`);
             if (buttonToClick) {
                 setTimeout(()=> {
                    showMessagePricing(`Silakan pilih metode pembayaran untuk Plan ${autoSelectPlan}.`, 'info');
                    buttonToClick.click();
                 }, 500);
             }
        }

        async function checkPendingMidtransTransaction() {
            const pendingTxOrderId = localStorage.getItem('pendingMidtransOrder');
            const pendingPlan = localStorage.getItem('pendingMidtransPlan');

            if (pendingTxOrderId && pendingPlan && token) {
                messageAreaPricing.innerHTML = `Memeriksa status pembayaran (Order ID: ${pendingTxOrderId})... <div class="spinner" style="width:20px; height:20px; border:3px solid rgba(255,255,255,.1); border-left-color:#58a6ff; border-radius:50%; display:inline-block; animation: spin 1s linear infinite; vertical-align:middle; margin-left:5px;"></div>`;
                messageAreaPricing.className = "message info";
                messageAreaPricing.style.display = "block";
                gsap.fromTo(messageAreaPricing, {opacity:0, y:-10}, {opacity:1, y:0, duration:0.3});

                let attempts = 0; const maxAttempts = 5; const intervalTime = 3000; 
                const attemptFetch = async () => {
                    attempts++;
                    try {
                        const profileRes = await fetch('/api/user/profile', { headers: { 'Authorization': `Bearer ${token}` } });
                        const profileData = await profileRes.json();
                        if (profileData.success && profileData.user) {
                            loggedInUser = profileData.user; 
                            localStorage.setItem('wanzofcUser', JSON.stringify(profileData.user));
                            if (profileData.user.plan === pendingPlan) {
                                const planExpiration = profileData.user.planExpirationDate ? new Date(profileData.user.planExpirationDate) : null;
                                if (planExpiration && planExpiration > new Date()) {
                                    showMessagePricing(`Pembayaran berhasil! Anda sekarang menggunakan plan ${pendingPlan}.`, "success");
                                    localStorage.removeItem('pendingMidtransOrder'); localStorage.removeItem('pendingMidtransPlan');
                                    return; 
                                }
                            }
                        }
                        if (attempts >= maxAttempts) {
                            showMessagePricing(`Status pembayaran untuk Order ID: ${pendingTxOrderId} (Plan: ${pendingPlan}) belum terkonfirmasi. Silakan cek dashboard atau hubungi support.`, "error");
                            localStorage.removeItem('pendingMidtransOrder'); localStorage.removeItem('pendingMidtransPlan');
                        } else { setTimeout(attemptFetch, intervalTime); }
                    } catch (err) {
                         if (attempts >= maxAttempts) {
                            showMessagePricing("Terjadi kesalahan saat memeriksa status pembayaran. Silakan cek dashboard Anda.", "error");
                            localStorage.removeItem('pendingMidtransOrder'); localStorage.removeItem('pendingMidtransPlan');
                         } else { setTimeout(attemptFetch, intervalTime); }
                    }
                };
                setTimeout(attemptFetch, intervalTime);
            }
        }
        checkPendingMidtransTransaction();
    </script>
</body>
</html>